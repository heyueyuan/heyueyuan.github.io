<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Music-Recommendation | Mark He</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.9854472c.css" as="style"><link rel="preload" href="/assets/js/app.265cfc62.js" as="script"><link rel="preload" href="/assets/js/23.67e27de0.js" as="script"><link rel="prefetch" href="/assets/js/10.aeb08d6d.js"><link rel="prefetch" href="/assets/js/11.c47163b6.js"><link rel="prefetch" href="/assets/js/12.915cb852.js"><link rel="prefetch" href="/assets/js/13.eff9359d.js"><link rel="prefetch" href="/assets/js/14.a7c6041b.js"><link rel="prefetch" href="/assets/js/15.d636104a.js"><link rel="prefetch" href="/assets/js/16.5692cdd2.js"><link rel="prefetch" href="/assets/js/17.69126d01.js"><link rel="prefetch" href="/assets/js/18.6eeb36a9.js"><link rel="prefetch" href="/assets/js/19.58fca24d.js"><link rel="prefetch" href="/assets/js/2.6ce74938.js"><link rel="prefetch" href="/assets/js/20.25d4abb7.js"><link rel="prefetch" href="/assets/js/21.60fbe128.js"><link rel="prefetch" href="/assets/js/22.1c918ce7.js"><link rel="prefetch" href="/assets/js/24.22e1499d.js"><link rel="prefetch" href="/assets/js/25.02c31893.js"><link rel="prefetch" href="/assets/js/26.ec379253.js"><link rel="prefetch" href="/assets/js/27.df1dfb7c.js"><link rel="prefetch" href="/assets/js/28.e5f55e62.js"><link rel="prefetch" href="/assets/js/29.4ab53bc8.js"><link rel="prefetch" href="/assets/js/3.89d1e693.js"><link rel="prefetch" href="/assets/js/30.13a47086.js"><link rel="prefetch" href="/assets/js/31.3e08bbf0.js"><link rel="prefetch" href="/assets/js/32.49e8d2f1.js"><link rel="prefetch" href="/assets/js/33.34b0a6b7.js"><link rel="prefetch" href="/assets/js/34.6c1ac4bc.js"><link rel="prefetch" href="/assets/js/35.521abc2d.js"><link rel="prefetch" href="/assets/js/36.c1ba9b6b.js"><link rel="prefetch" href="/assets/js/37.1b798d69.js"><link rel="prefetch" href="/assets/js/38.9409643a.js"><link rel="prefetch" href="/assets/js/39.8178cfd3.js"><link rel="prefetch" href="/assets/js/4.93bfe19f.js"><link rel="prefetch" href="/assets/js/40.72bda93a.js"><link rel="prefetch" href="/assets/js/41.0a2d9067.js"><link rel="prefetch" href="/assets/js/42.1e3cfe94.js"><link rel="prefetch" href="/assets/js/43.2a8a6955.js"><link rel="prefetch" href="/assets/js/44.f0df4491.js"><link rel="prefetch" href="/assets/js/45.0ec4ef64.js"><link rel="prefetch" href="/assets/js/46.d8ab0cfb.js"><link rel="prefetch" href="/assets/js/47.101b564b.js"><link rel="prefetch" href="/assets/js/48.10290b31.js"><link rel="prefetch" href="/assets/js/49.6f0c6b8b.js"><link rel="prefetch" href="/assets/js/5.7c652252.js"><link rel="prefetch" href="/assets/js/50.48ff2154.js"><link rel="prefetch" href="/assets/js/51.8c372db5.js"><link rel="prefetch" href="/assets/js/52.1188b68c.js"><link rel="prefetch" href="/assets/js/53.a04fdb75.js"><link rel="prefetch" href="/assets/js/54.66b64b21.js"><link rel="prefetch" href="/assets/js/55.923fa6e5.js"><link rel="prefetch" href="/assets/js/56.f51a4e44.js"><link rel="prefetch" href="/assets/js/57.ee90ffbd.js"><link rel="prefetch" href="/assets/js/58.a0fb6737.js"><link rel="prefetch" href="/assets/js/59.5581418f.js"><link rel="prefetch" href="/assets/js/6.397be193.js"><link rel="prefetch" href="/assets/js/60.cba6de65.js"><link rel="prefetch" href="/assets/js/61.6046c511.js"><link rel="prefetch" href="/assets/js/62.9dce1a90.js"><link rel="prefetch" href="/assets/js/63.d8a483b0.js"><link rel="prefetch" href="/assets/js/7.f883906b.js"><link rel="prefetch" href="/assets/js/8.e9363c12.js"><link rel="prefetch" href="/assets/js/9.e10c76be.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9854472c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Mark He</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/articles/datascience/" class="nav-link router-link-active">Data Science</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Development</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Full-Stack</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/articles/development/python/" class="nav-link">Python</a></li><li class="dropdown-subitem"><a href="/articles/development/java/" class="nav-link">Java</a></li><li class="dropdown-subitem"><a href="/articles/development/vue/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/articles/development/Git/" class="nav-link">Git</a></li><li class="dropdown-subitem"><a href="/articles/development/tool/" class="nav-link">Tools</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/articles/algorithm/" class="nav-link">Algorithm</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Network</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/articles/network/R_S/" class="nav-link">Router&amp;Switch</a></li><li class="dropdown-item"><!----> <a href="/articles/network/malfunction/" class="nav-link">Malfunction</a></li></ul></div></div><div class="nav-item"><a href="/articles/speech/" class="nav-link">Speech</a></div><div class="nav-item"><a href="/articles/goals.html" class="nav-link">Goals</a></div><div class="nav-item"><a href="/articles/prepforjob.html" class="nav-link">PrepForJobs</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/articles/datascience/" class="nav-link router-link-active">Data Science</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Development</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Full-Stack</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/articles/development/python/" class="nav-link">Python</a></li><li class="dropdown-subitem"><a href="/articles/development/java/" class="nav-link">Java</a></li><li class="dropdown-subitem"><a href="/articles/development/vue/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/articles/development/Git/" class="nav-link">Git</a></li><li class="dropdown-subitem"><a href="/articles/development/tool/" class="nav-link">Tools</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/articles/algorithm/" class="nav-link">Algorithm</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Network</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/articles/network/R_S/" class="nav-link">Router&amp;Switch</a></li><li class="dropdown-item"><!----> <a href="/articles/network/malfunction/" class="nav-link">Malfunction</a></li></ul></div></div><div class="nav-item"><a href="/articles/speech/" class="nav-link">Speech</a></div><div class="nav-item"><a href="/articles/goals.html" class="nav-link">Goals</a></div><div class="nav-item"><a href="/articles/prepforjob.html" class="nav-link">PrepForJobs</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Data Science</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Deep Learning</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Machine Learning</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Big-Data</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/articles/datascience/Big-Data.html" class="sidebar-link">Spark</a></li><li><a href="/articles/datascience/Music-Recommendation.html" class="active sidebar-link">Music-Recommendation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/datascience/Music-Recommendation.html#collaborative-filtering" class="sidebar-link">Collaborative filtering</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>SQL</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Data Warehouse</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>R</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Resource</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="music-recommendation">Music-Recommendation</h1> <h1 id="一、环境启动">一、环境启动</h1> <div class="language-powershell extra-class"><pre class="language-powershell"><code>spark<span class="token operator">-</span>shell <span class="token operator">--</span>driver<span class="token operator">-</span>memory 8g <span class="token operator">--</span>conf spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>crossJoin<span class="token punctuation">.</span>enabled=true
</code></pre></div><h1 id="二、数据集">二、数据集</h1> <p>使用 Audioscrobbler 公开发布的一个数据集。Audioscrobbler 是 last.fm 的第一个音乐推荐系统。last.fm 创建于 2002 年，是最早的互联 网流媒体广播站点之一。Audioscrobbler 提供了开放 的“scrobbling”API，“scrobbling”可以记录听众播放过哪些艺术家的歌 曲。last.fm(https://www.last.fm/ )使用这些音乐播放记录构建了一个 强大的音乐推荐引擎。由于第三方应用和网站可以把音乐播放数据反馈 给这个推荐引擎，这个推荐引擎系统覆盖了数百万的用户。</p> <p>然而，人们虽然经常听音乐，但很少给音乐评分。因此 Audioscrobbler 数据集要大得多，它覆盖了更多的用户和艺术家，也包含了更多的总体 信息，虽然单条记录的信息比较少。这种类型的数据通常被称为隐式反 馈数据 ，因为用户和艺术家的关系是通过其他行动隐含体现出来的， 而不是通过显式的评分或点赞得到的。</p> <p>http://www.iro.umontreal.ca/~lisa/datasets/profiledata_06-May-2005.tar.gz</p> <p>主要的数据集在文件 user_artist_data.txt 中，它包含 141 000 个用户和 160 万个艺术家，记录 了约 2420 万条用户播放艺术家歌曲的信息，其中包括播放次数信息。数据集在 artist_data.txt 文件中给出了每个艺术家的 ID 和对应的名字。 请注意，记录播放信息时，客户端应用提交的是艺术家的名字。名字如 果有拼写错误，或使用了非标准的名称，事后才能被发现。比 如，“The Smiths”“Smiths, The”和“the smiths”看似代表不同艺术家的 ID，但它们其实明显是指同一个艺术家。因此，为了将拼写错误的艺术 家 ID 或 ID 变体对应到该艺术家的规范 ID，数据集提供了 artist_alias.txt 文件。</p> <h1 id="三、算法（alternating-least-square-）">三、算法（Alternating Least Square ）</h1> <h2 id="collaborative-filtering"><a href="https://en.wikipedia.org/wiki/Collaborative_filtering" target="_blank" rel="noopener noreferrer">Collaborative filtering<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h2> <p>Collaborative filtering (CF) is a technique used by recommender systems. Collaborative filtering has two senses, a narrow one and a more general one.</p> <h3 id="model-based">Model-based</h3> <p>In this approach, models are developed using different <a href="https://en.wikipedia.org/wiki/Data_mining" target="_blank" rel="noopener noreferrer">data mining<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://en.wikipedia.org/wiki/Machine_learning" target="_blank" rel="noopener noreferrer">machine learning<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> algorithms to predict users' rating of unrated items. There are many model-based CF algorithms. <a href="https://en.wikipedia.org/wiki/Bayesian_networks" target="_blank" rel="noopener noreferrer">Bayesian networks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://en.wikipedia.org/wiki/Cluster_Analysis" target="_blank" rel="noopener noreferrer">clustering models<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://en.wikipedia.org/wiki/Latent_Semantic_Indexing" target="_blank" rel="noopener noreferrer">latent semantic models<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> such as <a href="https://en.wikipedia.org/wiki/Singular_value_decomposition" target="_blank" rel="noopener noreferrer">singular value decomposition<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://en.wikipedia.org/wiki/Probabilistic_latent_semantic_analysis" target="_blank" rel="noopener noreferrer">probabilistic latent semantic analysis<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, multiple multiplicative factor, <a href="https://en.wikipedia.org/wiki/Latent_Dirichlet_allocation" target="_blank" rel="noopener noreferrer">latent Dirichlet allocation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://en.wikipedia.org/wiki/Markov_decision_process" target="_blank" rel="noopener noreferrer">Markov decision process<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> based models.[<a href="https://en.wikipedia.org/wiki/Collaborative_filtering#cite_note-Suetal2009-5" target="_blank" rel="noopener noreferrer">5]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Through this approach, <a href="https://en.wikipedia.org/wiki/Dimensionality_reduction" target="_blank" rel="noopener noreferrer">dimensionality reduction<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> methods are mostly being used as complementary technique to improve robustness and accuracy of memory-based approach. In this sense, methods like <a href="https://en.wikipedia.org/wiki/Singular_value_decomposition" target="_blank" rel="noopener noreferrer">singular value decomposition<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://en.wikipedia.org/wiki/Principal_component_analysis" target="_blank" rel="noopener noreferrer">principal component analysis<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, known as latent factor models, compress user-item matrix into a low-dimensional representation in terms of latent factors. One advantage of using this approach is that instead of having a high dimensional matrix containing abundant number of missing values we will be dealing with a much smaller matrix in lower-dimensional space. A reduced presentation could be utilized for either user-based or item-based neighborhood algorithms that are presented in the previous section. There are several advantages with this paradigm. It handles the <a href="https://en.wikipedia.org/wiki/Sparse_matrix" target="_blank" rel="noopener noreferrer">sparsity<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> of the original matrix better than memory based ones. Also comparing similarity on the resulting matrix is much more scalable especially in dealing with large sparse datasets.[<a href="https://en.wikipedia.org/wiki/Collaborative_filtering#cite_note-:0-6" target="_blank" rel="noopener noreferrer">6]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="challenges">Challenges</h3> <h3 id="data-sparsity">Data sparsity</h3> <p>In practice, many commercial recommender systems are based on large datasets. As a result, the user-item matrix used for collaborative filtering could be extremely large and sparse, which brings about the challenges in the performances of the recommendation.</p> <p>One typical problem caused by the data sparsity is the <a href="https://en.wikipedia.org/wiki/Cold_start_(computing)" target="_blank" rel="noopener noreferrer">cold start<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> problem. As collaborative filtering methods recommend items based on users' past preferences, new users will need to rate sufficient number of items to enable the system to capture their preferences accurately and thus provides reliable recommendations.</p> <p>Similarly, new items also have the same problem. When new items are added to the system, they need to be rated by a substantial number of users before they could be recommended to users who have similar tastes to the ones who rated them. The new item problem does not affect <a href="https://en.wikipedia.org/wiki/Content-based_filtering" target="_blank" rel="noopener noreferrer">content-based recommendations<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, because the recommendation of an item is based on its discrete set of descriptive qualities rather than its ratings.</p> <p>数学 上，这些算法把用户和产品数据当成一个大矩阵 <em>A</em> ，矩阵第 <em>i</em> 行和第 <em>j</em> 列上的元素有值，代表用户 <em>i</em> 播放过艺术家 <em>j</em> 的音乐。矩阵 <em>A</em> 是稀疏 的:<em>A</em> 中大多数元素都是 0，因为相对于所有可能的用户 - 艺术家组 合，只有很少一部分组合会出现在数据中。算法将 <em>A</em> 分解为两个小矩阵 <em>X</em> 和 <em>Y</em> 的乘积。矩阵 <em>X</em> 和矩阵 <em>Y</em> 非常“瘦”，因为 <em>A</em> 有很多行和列，但 <em>X</em> 和 <em>Y</em> 的行很多而列很少(列数用 <em>k</em> 表示)。这 <em>k</em> 个列就是潜在因素，用 于解释数据中的交互关系。</p> <h1 id="四、准备数据">四、准备数据</h1> <p>Spark MLlib 的 ALS 算法实现并不严格要求用户和产品的 ID 必须是数 值型，不过当 ID 为 32 位非负整数时，效率会更高。使用 Int 表示 ID 是有好处的，但同时意味着 ID 不能超过 Int 的最大值 (Int.MaxValue )，即 2147483647。我们的数据集是否已经满足了这 个要求?利用 SparkSession 的 textFile 方法，将数据文件转换成 String 类型的数据集:</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> rawUserArtistData <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;/Users/mark/Learning/profiledata_06-May-2005/user_artist_data.txt&quot;</span><span class="token punctuation">)</span>
rawUserArtistData<span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span>
</code></pre></div><p>文件的每行包含一个用户 ID、一个艺术家 ID 和播放次数，用空格分 隔。要计算用户 ID 的统计信息，可以用空格拆分每行，并将前两个值 解析为整数，其结果在概念上可以看成 Int 类型的两个列:用户 ID 和 艺术家 ID。将其转换为包含列 user 和 artist 的 DataFrame 是有意义 的，因为这样就可以简单地计算出两列的最大值和最小值:</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> userArtistDF <span class="token operator">=</span> rawUserArtistData<span class="token punctuation">.</span>map <span class="token punctuation">{</span> line <span class="token keyword">=&gt;</span> 
    <span class="token keyword">val</span> Array<span class="token punctuation">(</span>user<span class="token punctuation">,</span> artist<span class="token punctuation">,</span> _<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span>user<span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> artist<span class="token punctuation">.</span>toInt<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span>

userArtistDF<span class="token punctuation">.</span>agg<span class="token punctuation">(</span>
min<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> min<span class="token punctuation">(</span><span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max<span class="token punctuation">(</span><span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>map() 函数要求对每个输入必须严格返回一个值，因此这里不能 用这个函数。另一种可行的方法是用 filter() 方法删除那些无法解析 的行，但这会重复解析逻辑。当需要将每个元素映射为零个、一个或更 多结果时，我们应该使用 flatMap() 函数，因为它将每个输入对应的 零个或多个结果组成的集合简单展开，然后放入到一个更大的数据集中。它可以和 Scala 集合一起使用，也可以和 Scala 的 Option 类一起使 用。Option 代表一个值可以不存在，有点儿像只有 1 或 0 的一个简单 集合，1 对应子类 Some ，0 对应子类 None 。因此在以下代码中，虽然 flatMap 中的函数本可以简单返回一个空 List ，或一个只有一个元素 的 List ，但使用 Some 和 None 更合理，这种方法简单明了。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> rawArtistData <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;/Users/mark/Learning/profiledata_06-May-2005/artist_data.txt&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> artistByID <span class="token operator">=</span> rawArtistData<span class="token punctuation">.</span>flatMap <span class="token punctuation">{</span> line <span class="token keyword">=&gt;</span> 
    <span class="token keyword">val</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">=</span> line<span class="token punctuation">.</span>span<span class="token punctuation">(</span>_ <span class="token operator">!=</span> <span class="token string">'\t'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    None 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Some<span class="token punctuation">(</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> name<span class="token punctuation">.</span>trim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> _<span class="token operator">:</span> NumberFormatException <span class="token keyword">=&gt;</span> None <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>artist_alias.txt 将拼写错误的艺术家 ID 或非标准的艺术家 ID 映射为艺术 家的正规名字。其中每行有两个 ID，用制表符分隔。这个文件相对较 小，有 200 000 个记录。有必要把它转成 Map 集合的形式，将“不良 的”艺术家 ID 映射到“良好的”ID，而不是简单地把它作为包含艺术家 ID 二元组的数据集。这里又有一点小问题:由于某种原因有些行没有 艺术家的第一个 ID。这些行将被过滤掉:</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> rawArtistAlias <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;/Users/mark/Learning/profiledata_06-May-2005/artist_alias.txt&quot;</span><span class="token punctuation">)</span> 
<span class="token keyword">val</span> artistAlias <span class="token operator">=</span> rawArtistAlias<span class="token punctuation">.</span>flatMap <span class="token punctuation">{</span> line <span class="token keyword">=&gt;</span>
    <span class="token keyword">val</span> Array<span class="token punctuation">(</span>artist<span class="token punctuation">,</span> alias<span class="token punctuation">)</span> <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>artist<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>   
        None 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        Some<span class="token punctuation">(</span><span class="token punctuation">(</span>artist<span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> alias<span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toMap
</code></pre></div><p>比如，第一条将 ID 1208690 映射为 1003926。接下来我们可以从包含艺 术家名字的数据集中进行查找:</p> <div class="language-scala extra-class"><pre class="language-scala"><code>artistByID<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>$<span class="token string">&quot;id&quot;</span> isin <span class="token punctuation">(</span><span class="token number">1208690</span><span class="token punctuation">,</span> <span class="token number">1003926</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="五、构建模型">五、构建模型</h1> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql</span><span class="token punctuation">.</span>_ 
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>broadcast</span><span class="token punctuation">.</span>_

<span class="token keyword">def</span> buildCounts<span class="token punctuation">(</span>
    rawUserArtistData<span class="token operator">:</span> Dataset<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    bArtistAlias<span class="token operator">:</span> Broadcast<span class="token punctuation">[</span>Map<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> DataFrame <span class="token operator">=</span> <span class="token punctuation">{</span>
    rawUserArtistData<span class="token punctuation">.</span>map <span class="token punctuation">{</span> line <span class="token keyword">=&gt;</span>
    <span class="token keyword">val</span> Array<span class="token punctuation">(</span>userID<span class="token punctuation">,</span> artistID<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>toInt<span class="token punctuation">)</span> 
    <span class="token keyword">val</span> finalArtistID <span class="token operator">=</span>
    bArtistAlias<span class="token punctuation">.</span>value<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span>artistID<span class="token punctuation">,</span> artistID<span class="token punctuation">)</span> 
    <span class="token punctuation">(</span>userID<span class="token punctuation">,</span> finalArtistID<span class="token punctuation">,</span> count<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;artist&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">val</span> bArtistAlias <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>artistAlias<span class="token punctuation">)</span>
<span class="token keyword">val</span> trainData <span class="token operator">=</span> buildCounts<span class="token punctuation">(</span>rawUserArtistData<span class="token punctuation">,</span> bArtistAlias<span class="token punctuation">)</span> 
trainData<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>为 artistAlias 创建一个广播变量，取名为bArtistAlias 。使用广播变量时，Spark 对集群中每个 executor 只发 送一个副本，并且在内存里也只保存一个副本。如果有几千个任务在 executor 上并行执行，使用广播变量能节省巨大的网络流量和内存。</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>ml<span class="token punctuation">.</span>recommendation</span><span class="token punctuation">.</span>_ 
<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span>Random
<span class="token keyword">val</span> model <span class="token operator">=</span> <span class="token keyword">new</span> ALS<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setSeed<span class="token punctuation">(</span>Random<span class="token punctuation">.</span>nextLong<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setImplicitPrefs<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    setRank<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    setRegParam<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    setAlpha<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setMaxIter<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    setUserCol<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    setItemCol<span class="token punctuation">(</span><span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    setRatingCol<span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setPredictionCol<span class="token punctuation">(</span><span class="token string">&quot;prediction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    fit<span class="token punctuation">(</span>trainData<span class="token punctuation">)</span>
</code></pre></div><p>特征向量</p> <div class="language-scala extra-class"><pre class="language-scala"><code>model<span class="token punctuation">.</span>userFactors<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> truncate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre></div><p>检查推荐结果</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> userID <span class="token operator">=</span> <span class="token number">2093760</span>
<span class="token keyword">val</span> existingArtistIDs <span class="token operator">=</span> trainData<span class="token punctuation">.</span> 
    filter<span class="token punctuation">(</span>$<span class="token string">&quot;user&quot;</span> <span class="token operator">==</span><span class="token operator">=</span> userID<span class="token punctuation">)</span><span class="token punctuation">.</span>
    select<span class="token punctuation">(</span><span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span> 
artistByID<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>$<span class="token string">&quot;id&quot;</span> isin <span class="token punctuation">(</span>existingArtistIDs<span class="token operator">:</span>_<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre></div><div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">def</span> makeRecommendations<span class="token punctuation">(</span>
    model<span class="token operator">:</span> ALSModel<span class="token punctuation">,</span>
    userID<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>
    howMany<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> DataFrame <span class="token operator">=</span> <span class="token punctuation">{</span>

<span class="token keyword">val</span> toRecommend <span class="token operator">=</span> model<span class="token punctuation">.</span>itemFactors<span class="token punctuation">.</span> 
    select<span class="token punctuation">(</span>$<span class="token string">&quot;id&quot;</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    withColumn<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> lit<span class="token punctuation">(</span>userID<span class="token punctuation">)</span><span class="token punctuation">)</span> 

model<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>toRecommend<span class="token punctuation">)</span><span class="token punctuation">.</span> 
    select<span class="token punctuation">(</span><span class="token string">&quot;artist&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;prediction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    orderBy<span class="token punctuation">(</span>$<span class="token string">&quot;prediction&quot;</span><span class="token punctuation">.</span>desc<span class="token punctuation">)</span><span class="token punctuation">.</span> 
    limit<span class="token punctuation">(</span>howMany<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre></div><div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> topRecommendations <span class="token operator">=</span> makeRecommendations<span class="token punctuation">(</span>model<span class="token punctuation">,</span> userID<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> 
topRecommendations<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>查找艺术家姓名</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> recommendedArtistIDs <span class="token operator">=</span> topRecommendations<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>
artistByID<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>$<span class="token string">&quot;id&quot;</span> isin <span class="token punctuation">(</span>recommendedArtistIDs<span class="token operator">:</span>_<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>计算<strong>AUC</strong></p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable</span><span class="token punctuation">.</span>ArrayBuffer

<span class="token keyword">def</span> areaUnderCurve<span class="token punctuation">(</span>
      positiveData<span class="token operator">:</span> DataFrame<span class="token punctuation">,</span>
      bAllArtistIDs<span class="token operator">:</span> Broadcast<span class="token punctuation">[</span>Array<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      predictFunction<span class="token operator">:</span> <span class="token punctuation">(</span>DataFrame <span class="token keyword">=&gt;</span> DataFrame<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token comment">// What this actually computes is AUC, per user. The result is actually something</span>
    <span class="token comment">// that might be called &quot;mean AUC&quot;.</span>

    <span class="token comment">// Take held-out data as the &quot;positive&quot;.</span>
    <span class="token comment">// Make predictions for each of them, including a numeric score</span>
    <span class="token keyword">val</span> positivePredictions <span class="token operator">=</span> predictFunction<span class="token punctuation">(</span>positiveData<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
      withColumnRenamed<span class="token punctuation">(</span><span class="token string">&quot;prediction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;positivePrediction&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">// BinaryClassificationMetrics.areaUnderROC is not used here since there are really lots of</span>
    <span class="token comment">// small AUC problems, and it would be inefficient, when a direct computation is available.</span>

    <span class="token comment">// Create a set of &quot;negative&quot; products for each user. These are randomly chosen</span>
    <span class="token comment">// from among all of the other artists, excluding those that are &quot;positive&quot; for the user.</span>
    <span class="token keyword">val</span> negativeData <span class="token operator">=</span> positiveData<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>
      groupByKey <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token punctuation">(</span>user<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> user <span class="token punctuation">}</span><span class="token punctuation">.</span>
      flatMapGroups <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token punctuation">(</span>userID<span class="token punctuation">,</span> userIDAndPosArtistIDs<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
        <span class="token keyword">val</span> random <span class="token operator">=</span> <span class="token keyword">new</span> Random<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> posItemIDSet <span class="token operator">=</span> userIDAndPosArtistIDs<span class="token punctuation">.</span>map <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> artist<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> artist <span class="token punctuation">}</span><span class="token punctuation">.</span>toSet
        <span class="token keyword">val</span> negative <span class="token operator">=</span> <span class="token keyword">new</span> ArrayBuffer<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> allArtistIDs <span class="token operator">=</span> bAllArtistIDs<span class="token punctuation">.</span>value
        <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment">// Make at most one pass over all artists to avoid an infinite loop.</span>
        <span class="token comment">// Also stop when number of negative equals positive set size</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> allArtistIDs<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> negative<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> posItemIDSet<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">val</span> artistID <span class="token operator">=</span> allArtistIDs<span class="token punctuation">(</span>random<span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span>allArtistIDs<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token comment">// Only add new distinct IDs</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>posItemIDSet<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>artistID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            negative <span class="token operator">+=</span> artistID
          <span class="token punctuation">}</span>
          i <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Return the set with user ID added back</span>
        negative<span class="token punctuation">.</span>map<span class="token punctuation">(</span>artistID <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>userID<span class="token punctuation">,</span> artistID<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">// Make predictions on the rest:</span>
    <span class="token keyword">val</span> negativePredictions <span class="token operator">=</span> predictFunction<span class="token punctuation">(</span>negativeData<span class="token punctuation">)</span><span class="token punctuation">.</span>
      withColumnRenamed<span class="token punctuation">(</span><span class="token string">&quot;prediction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;negativePrediction&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">// Join positive predictions to negative predictions by user, only.</span>
    <span class="token comment">// This will result in a row for every possible pairing of positive and negative</span>
    <span class="token comment">// predictions within each user.</span>
    <span class="token keyword">val</span> joinedPredictions <span class="token operator">=</span> positivePredictions<span class="token punctuation">.</span>join<span class="token punctuation">(</span>negativePredictions<span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
      select<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;positivePrediction&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;negativePrediction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Count the number of pairs per user</span>
    <span class="token keyword">val</span> allCounts <span class="token operator">=</span> joinedPredictions<span class="token punctuation">.</span>
      groupBy<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span>count<span class="token punctuation">(</span>lit<span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;total&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
      select<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;total&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// Count the number of correctly ordered pairs per user</span>
    <span class="token keyword">val</span> correctCounts <span class="token operator">=</span> joinedPredictions<span class="token punctuation">.</span>
      filter<span class="token punctuation">(</span>$<span class="token string">&quot;positivePrediction&quot;</span> <span class="token operator">&gt;</span> $<span class="token string">&quot;negativePrediction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
      groupBy<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span>count<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;correct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
      select<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;correct&quot;</span><span class="token punctuation">)</span>

    <span class="token comment">// Combine these, compute their ratio, and average over all users</span>
    <span class="token keyword">val</span> meanAUC <span class="token operator">=</span> allCounts<span class="token punctuation">.</span>join<span class="token punctuation">(</span>correctCounts<span class="token punctuation">,</span> Seq<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;left_outer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
      select<span class="token punctuation">(</span>$<span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>coalesce<span class="token punctuation">(</span>$<span class="token string">&quot;correct&quot;</span><span class="token punctuation">,</span> lit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> $<span class="token string">&quot;total&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;auc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
      agg<span class="token punctuation">(</span>mean<span class="token punctuation">(</span><span class="token string">&quot;auc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
      as<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>

    joinedPredictions<span class="token punctuation">.</span>unpersist<span class="token punctuation">(</span><span class="token punctuation">)</span>

    meanAUC
  <span class="token punctuation">}</span>
</code></pre></div><p>训练集只用于 训练 ALS 模型，验证集用于评估模型。</p> <p>90% 的数据用于训 练，剩余的 10% 用于交叉验证:</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> allData <span class="token operator">=</span> buildCounts<span class="token punctuation">(</span>rawUserArtistData<span class="token punctuation">,</span> bArtistAlias<span class="token punctuation">)</span> 
<span class="token keyword">val</span> Array<span class="token punctuation">(</span>trainData<span class="token punctuation">,</span> cvData<span class="token punctuation">)</span> <span class="token operator">=</span> allData<span class="token punctuation">.</span>randomSplit<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
trainData<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
cvData<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> allArtistIDs <span class="token operator">=</span> allData<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distinct<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">val</span> bAllArtistIDs <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>allArtistIDs<span class="token punctuation">)</span>
<span class="token keyword">val</span> model <span class="token operator">=</span> <span class="token keyword">new</span> ALS<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setSeed<span class="token punctuation">(</span>Random<span class="token punctuation">.</span>nextLong<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setImplicitPrefs<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    setRank<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setRegParam<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setAlpha<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setMaxIter<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    setUserCol<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setItemCol<span class="token punctuation">(</span><span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    setRatingCol<span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setPredictionCol<span class="token punctuation">(</span><span class="token string">&quot;prediction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    fit<span class="token punctuation">(</span>trainData<span class="token punctuation">)</span>

areaUnderCurve<span class="token punctuation">(</span>cvData<span class="token punctuation">,</span> bAllArtistIDs<span class="token punctuation">,</span> model<span class="token punctuation">.</span>transform<span class="token punctuation">)</span>
</code></pre></div><h1 id="六、超参数">六、超参数</h1> <ul><li>setRank(10)</li></ul> <p>模型的潜在因素的个数，即“用户 - 特征”和“产品 - 特征”矩阵的列 数;一般来说，它也是矩阵的阶。</p> <ul><li>setMaxIter(5)</li></ul> <p>矩阵分解迭代的次数;迭代的次数越多，花费的时间越长，但分解 的结果可能会更好。</p> <ul><li>setRegParam(0.01)</li></ul> <p>标准的过拟合参数，通常也称作 lambda;值越大越不容易产生过拟 合，但值太大会降低分解的准确率。</p> <ul><li>setAlpha(1.0)</li></ul> <p>控制矩阵分解时，被观察到的“用户 - 产品”交互相对没被观察到的 交互的权重。</p> <p>8 种可能的组合:rank = 5 或 30，regParam = 4.0 或 0.0001，以及 alpha = 1.0 或 40.0</p> <div class="language-scala extra-class"><pre class="language-scala"><code> <span class="token keyword">val</span> evaluations <span class="token operator">=</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>rank <span class="token keyword">&lt;-</span> Seq<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
regParam <span class="token keyword">&lt;-</span> Seq<span class="token punctuation">(</span><span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token number">0.0001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
alpha <span class="token keyword">&lt;-</span> Seq<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">40.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token keyword">yield</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> model <span class="token operator">=</span> <span class="token keyword">new</span> ALS<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setSeed<span class="token punctuation">(</span>Random<span class="token punctuation">.</span>nextLong<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setImplicitPrefs<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setRank<span class="token punctuation">(</span>rank<span class="token punctuation">)</span><span class="token punctuation">.</span>setRegParam<span class="token punctuation">(</span>regParam<span class="token punctuation">)</span><span class="token punctuation">.</span> 
    setAlpha<span class="token punctuation">(</span>alpha<span class="token punctuation">)</span><span class="token punctuation">.</span>
    setMaxIter<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    setUserCol<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setItemCol<span class="token punctuation">(</span><span class="token string">&quot;artist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    setRatingCol<span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    setPredictionCol<span class="token punctuation">(</span><span class="token string">&quot;prediction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span> 
    fit<span class="token punctuation">(</span>trainData<span class="token punctuation">)</span>
    <span class="token keyword">val</span> auc <span class="token operator">=</span> areaUnderCurve<span class="token punctuation">(</span>cvData<span class="token punctuation">,</span> bAllArtistIDs<span class="token punctuation">,</span> model<span class="token punctuation">.</span>transform<span class="token punctuation">)</span>

model<span class="token punctuation">.</span>userFactors<span class="token punctuation">.</span>unpersist<span class="token punctuation">(</span><span class="token punctuation">)</span> 
model<span class="token punctuation">.</span>itemFactors<span class="token punctuation">.</span>unpersist<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span>auc<span class="token punctuation">,</span> <span class="token punctuation">(</span>rank<span class="token punctuation">,</span> regParam<span class="token punctuation">,</span> alpha<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
evaluations<span class="token punctuation">.</span>sorted<span class="token punctuation">.</span>reverse<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">)</span> 
</code></pre></div><p>![image-20200112192514163](/Users/mark/Library/Application Support/typora-user-images/image-20200112192514163.png)</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/articles/datascience/Big-Data.html" class="prev">
          Spark
        </a></span> <span class="next"><a href="/articles/datascience/SQL.html">
          SQL 教程
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.265cfc62.js" defer></script><script src="/assets/js/23.67e27de0.js" defer></script>
  </body>
</html>
